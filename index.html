<!DOCTYPE html>
<html>
<head>
    <title>Lenta</title>
    <meta charset="UTF-8" />
    <style>
        .item {
            cursor: pointer;
        }

        input[type=text] {
            display: none;
            width: 890px;
        }

        .posting {
            display: none;
        }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript">
        function renderNewsItem(item) {
            var repr = $($('#template').html());
            $('td:first', repr).text(item.time);
            $('a', repr).text(item.title);
            $('a', repr).attr('href', item.url);
            $('.item', repr).text(item.summary);
            $('.item', repr).click(function() {
                $(this).siblings('input').toggle().focus();
            });
            $('input', repr).keydown(function(event) {
                if (event.which == 13) {
                    var input = $(this);
                    var params = repr.data();

                    if (params.posting) return;

                    params.text = input.attr('value');
                    input.attr('value', '');

                    repr.data('posting', true);
                    input.siblings('.posting').show();

                    $.post('/comment/', params, function(data) {
                        repr.data('posting', false);
                        input.siblings('.posting').hide();

                        var response = jQuery.parseJSON(data);
                        if (response.status == 'ok') {
                            repr.data('parent_id', response.comment_id);
                        } else if (response.status == 'error') {
                            alert(response.msg);
                        }
                    }).error(function() {
                        alert("Error while posting");
                        repr.data('posting', false);
                        input.siblings('.posting').hide();
                    });
                }
            });
            return repr;
        }

        function updateNewsList(item) {
            var matches = /\/news\/(.*?)\/$/.exec(item.url)
            var newsId = matches[1];
            var elId = newsId.replace(/\//g, '_');
            var el = $('#' + elId);
            if (!el.length) {
                var renderedItem = renderNewsItem(item);
                renderedItem.attr('id', elId);
                renderedItem.data('news_id', newsId);
                if (!firstRun) {
                    renderedItem.css('background-color', 'yellow'); // highlight
                }
                $('#news tbody').prepend(renderedItem);
                return true;
            } else {
                el.css('background-color', 'white');
                return false;
            }
        }

        function fetchNews() {
            $.getJSON('/news/', function(news) {
                var isUpdated = false;
                $.each(news, function(index, item) {
                    isUpdated += updateNewsList(item);
                });

                if (isUpdated) {
                    if (firstRun) {
                        firstRun = false;
                    } else {
                        snd.currentTime = 0;
                        snd.play();
                    }
                }
            }).complete(function() {
                setTimeout(fetchNews, 10000)
            })
        }

        var firstRun = true;
        var snd = new Audio('/static/notification.wav');
        $(document).ready(fetchNews);
    </script>
</head>
<body>
    <table id="news" align="center" width="1000" border="2">
        <thead>
            <th width="100">Time</th>
            <th>News</th>
        </thead>
        <tbody>
        </tbody>
    </table>
    <script type="text/template" id="template">
        <tr>
            <td></td>
            <td>
                <a></a>
                <div class="item"></div>
                <input type="text" />
                <div class="posting">posting...</div>
            </td>
        </tr>
    </script>
</body>
</html>
